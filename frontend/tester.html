<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lightning LaTeX TTS Tester</title>
  <style>
    :root {
      --bg: #0e1116;
      --panel: #161b22;
      --text: #e6edf3;
      --muted: #9da7b3;
      --accent: #2f81f7;
      --ok: #3fb950;
      --warn: #d29922;
      --err: #f85149;
      --border: #30363d;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: radial-gradient(circle at top right, #1f2a37, var(--bg) 55%);
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .app {
      width: min(900px, 100%);
      background: color-mix(in srgb, var(--panel) 92%, black);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
    }
    h1 {
      margin: 0 0 10px;
      font-size: 20px;
      font-weight: 700;
    }
    .sub {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 12px;
    }
    textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      font: 14px/1.5 Consolas, "Courier New", monospace;
      background: #0b0f14;
      color: var(--text);
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 14px;
      background: var(--accent);
      color: white;
      font-weight: 700;
      cursor: pointer;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .chip {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      color: var(--muted);
      background: #0c1219;
    }
    .status-idle { color: var(--muted); }
    .status-stream { color: var(--warn); }
    .status-play { color: var(--ok); }
    .status-err { color: var(--err); }
    .error {
      margin-top: 10px;
      min-height: 20px;
      color: var(--err);
      font-size: 13px;
      white-space: pre-wrap;
    }
    .cfg {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .cfg input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #0b0f14;
      color: var(--text);
      padding: 8px;
      font-size: 13px;
    }
    @media (max-width: 700px) {
      .cfg { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="app">
    <h1>LaTeX TTS Playground (Sophia)</h1>
    <div class="sub">Single-file tester using FastAPI <code>/lightning/stream</code>, PCM 24kHz mono, and Web Audio API.</div>

    <div class="cfg">
      <label>
        API Base
        <input id="apiBase" value="http://127.0.0.1:8000" />
      </label>
      <label>
        Voice ID
        <input id="voiceId" value="sophia" />
      </label>
    </div>

    <textarea id="latexInput">The key to this integral is substitution. Let u equal x^2 + 1, then du equals 2x dx. The trick is to convert \frac{1}{x^2 + 1} into arctangent form.</textarea>

    <div class="row">
      <button id="playBtn">Play</button>
      <span class="chip">Status: <strong id="status" class="status-idle">Idle</strong></span>
      <span class="chip">TTFB: <strong id="ttfb">-</strong></span>
      <span class="chip">Bytes: <strong id="bytes">0</strong></span>
    </div>

    <div id="error" class="error"></div>
  </main>

  <script>
    const playBtn = document.getElementById("playBtn");
    const statusEl = document.getElementById("status");
    const ttfbEl = document.getElementById("ttfb");
    const bytesEl = document.getElementById("bytes");
    const errorEl = document.getElementById("error");
    const latexInput = document.getElementById("latexInput");
    const apiBaseInput = document.getElementById("apiBase");
    const voiceIdInput = document.getElementById("voiceId");

    const SAMPLE_RATE = 24000;
    const CHANNELS = 1;
    const BYTES_PER_SAMPLE = 2;

    let ctx = null;
    let nextStartTime = 0;
    let isStreaming = false;

    function setStatus(text, cls) {
      statusEl.textContent = text;
      statusEl.className = cls;
    }

    function int16PcmToAudioBuffer(arrayBuffer, audioContext) {
      const int16 = new Int16Array(arrayBuffer);
      const frameCount = int16.length / CHANNELS;
      const audioBuffer = audioContext.createBuffer(CHANNELS, frameCount, SAMPLE_RATE);
      const channelData = audioBuffer.getChannelData(0);
      for (let i = 0; i < frameCount; i += 1) {
        channelData[i] = int16[i] / 32768;
      }
      return audioBuffer;
    }

    function queuePcmChunk(arrayBuffer) {
      const buffer = int16PcmToAudioBuffer(arrayBuffer, ctx);
      const source = ctx.createBufferSource();
      source.buffer = buffer;
      source.connect(ctx.destination);
      nextStartTime = Math.max(nextStartTime, ctx.currentTime + 0.02);
      source.start(nextStartTime);
      nextStartTime += buffer.duration;
    }

    async function streamAndPlay() {
      if (isStreaming) return;

      const latex = latexInput.value.trim();
      if (!latex) {
        errorEl.textContent = "Please enter LaTeX summary text.";
        return;
      }

      errorEl.textContent = "";
      ttfbEl.textContent = "-";
      bytesEl.textContent = "0";
      playBtn.disabled = true;
      isStreaming = true;

      try {
        if (!ctx) ctx = new AudioContext();
        if (ctx.state === "suspended") await ctx.resume();
        nextStartTime = ctx.currentTime + 0.06;

        const body = {
          latex_summary: latex,
          anchors_enabled: true,
          voice_id: (voiceIdInput.value || "sophia").trim() || "sophia",
          metadata: { source: "frontend/tester.html" }
        };

        const startedAt = performance.now();
        setStatus("Streaming...", "status-stream");

        const res = await fetch(`${apiBaseInput.value.replace(/\/+$/, "")}/lightning/stream`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        if (!res.body) throw new Error("No response body stream.");

        const reader = res.body.getReader();
        let firstByteSeen = false;
        let totalBytes = 0;

        setStatus("Playing", "status-play");

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          if (!value || value.byteLength === 0) continue;

          if (!firstByteSeen) {
            firstByteSeen = true;
            const ttfb = performance.now() - startedAt;
            ttfbEl.textContent = `${ttfb.toFixed(1)} ms`;
          }

          totalBytes += value.byteLength;
          bytesEl.textContent = String(totalBytes);
          queuePcmChunk(value.buffer.slice(value.byteOffset, value.byteOffset + value.byteLength));
        }

        setStatus("Idle", "status-idle");
      } catch (err) {
        setStatus("Error", "status-err");
        errorEl.textContent = err && err.message ? err.message : String(err);
      } finally {
        isStreaming = false;
        playBtn.disabled = false;
      }
    }

    playBtn.addEventListener("click", streamAndPlay);
  </script>
</body>
</html>
